<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Holiday Season with Caspar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0a;
            color: #e8e8e8;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            overflow: hidden;
            touch-action: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background 0.8s ease;
        }

        /* Background images for Christmas events */
        body.kupferkanne-active {
            background: #0a0a0a url('/kupferkanne.jpg') center/cover fixed;
        }

        body.kupferkanne-active::before {
            content: '';
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 10, 0.4);
            pointer-events: none;
            z-index: 1;
        }

        body.sauna-active {
            background: #0a0a0a url('/sauna-photo.jpg') center/cover fixed;
        }

        body.sauna-active::before {
            content: '';
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 10, 0.4);
            pointer-events: none;
            z-index: 1;
        }

        body.dinner-for-one-active {
            background: #0a0a0a url('/dinner-for-one.jpg') center/cover fixed;
        }

        body.dinner-for-one-active::before {
            content: '';
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 10, 0.4);
            pointer-events: none;
            z-index: 1;
        }



        #canvas-container {
            position: fixed;
            inset: 0;
            cursor: grab;
            z-index: 2;
        }

        #canvas-container.dragging {
            cursor: grabbing;
        }

        .ui-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 10;
        }

        /* Dark overlay for ring center - improves text readability */
        .ring-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40vmin;
            height: 40vmin;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(10, 10, 10, 0.92) 0%, rgba(10, 10, 10, 0.85) 50%, transparent 70%);
            pointer-events: none;
            z-index: 2;
            transition: background 0.5s ease;
        }

        /* Stronger overlay for dinner plate to ensure text readability */
        .ring-overlay.dinner-plate-active {
            background: radial-gradient(circle, rgba(10, 10, 10, 0.95) 0%, rgba(10, 10, 10, 0.92) 50%, rgba(10, 10, 10, 0.3) 70%);
        }

        @media (max-width: 768px) {
            .ring-overlay {
                width: 50vmin;
                height: 50vmin;
            }
        }

        /* Christmas emoji particles */
        .christmas-emoji {
            position: fixed;
            font-size: 3rem;
            pointer-events: none;
            z-index: 15;
            animation: christmas-float 3s ease-out forwards;
            user-select: none;
        }

        @keyframes christmas-float {
            0% {
                opacity: 0;
                transform: translate(0, 0) scale(0.5) rotate(0deg);
            }
            10% {
                opacity: 1;
            }
            70% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translate(var(--tx), var(--ty)) scale(1.5) rotate(var(--rotate));
            }
        }

        /* Beer emoji particles */
        .beer-emoji {
            position: fixed;
            font-size: 3rem;
            pointer-events: none;
            z-index: 15;
            animation: beer-float 3s ease-out forwards;
            user-select: none;
        }

        @keyframes beer-float {
            0% {
                opacity: 0;
                transform: translate(0, 0) scale(0.5) rotate(0deg);
            }
            10% {
                opacity: 1;
            }
            70% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translate(var(--tx), var(--ty)) scale(1.5) rotate(var(--rotate));
            }
        }

        /* YouTube video backgrounds */
        .youtube-video-bg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100vw;
            min-height: 100vh;
            width: auto;
            height: auto;
            z-index: 0;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        .youtube-video-bg.active {
            opacity: 1;
        }

        /* Header with sophisticated animation */
        .header {
            position: absolute;
            top: 6vh;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            width: 90%;
            z-index: 5;
            display: none; /* Hidden for now */
        }

        .title {
            font-size: clamp(1.4rem, 5vw, 2.8rem);
            font-weight: 600;
            letter-spacing: -0.02em;
            line-height: 1.05;
            color: #f5f5f7;
        }

        @media (max-width: 768px) {
            .title {
                font-size: clamp(1.1rem, 5.5vw, 1.8rem);
            }
        }

        /* Center Event Info */
        .center-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            opacity: 0;
            pointer-events: none;
            max-width: 85vw;
            z-index: 10;
        }

        .center-info.show {
            opacity: 1;
            pointer-events: auto;
        }

        .center-event {
            font-size: clamp(0.75rem, 2.2vw, 0.9rem);
            color: #86868b;
            letter-spacing: 0.01em;
            margin-bottom: 0.6rem;
            font-weight: 500;
            line-height: 1.3;
        }

        .center-date {
            font-size: clamp(0.65rem, 1.8vw, 0.75rem);
            color: #6e6e73;
            letter-spacing: 0.02em;
            margin-bottom: 0.8rem;
            font-weight: 400;
            text-transform: uppercase;
        }

        .center-time {
            font-size: clamp(2.2rem, 9vw, 3.5rem);
            font-weight: 300;
            letter-spacing: -0.02em;
            margin-bottom: 0.4rem;
            line-height: 1;
            color: #f5f5f7;
        }

        .center-location {
            font-size: clamp(0.75rem, 2vw, 0.85rem);
            color: #86868b;
            letter-spacing: 0.01em;
            margin-bottom: 1.8rem;
            font-weight: 400;
        }


        /* Monochrome RSVP Button */
        .rsvp-button {
            display: inline-block;
            padding: clamp(0.8rem, 3vw, 1rem) clamp(2rem, 8vw, 3rem);
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 50px;
            color: #e8e8e8;
            font-size: clamp(0.75rem, 2.5vw, 0.9rem);
            letter-spacing: 0.15em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: auto;
            backdrop-filter: blur(10px);
            font-weight: 300;
        }

        .rsvp-button:hover,
        .rsvp-button:active {
            background: rgba(255, 255, 255, 0.03);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* RSVP Modal - Brutalist Style */
        .rsvp-modal {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            background: #0a0a0a;
        }

        .rsvp-modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .rsvp-content {
            max-width: 600px;
            width: 90vw;
            text-align: left;
            position: relative;
            padding: 60px 20px 40px 20px;
            background: #0a0a0a;
            border-radius: 0 !important;
        }

        .rsvp-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            color: #FFFFFF;
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
            font-family: 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
            z-index: 10;
        }

        .rsvp-close-btn:hover {
            opacity: 0.7;
        }

        .rsvp-event-title {
            font-family: 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
            font-size: clamp(48px, 10vw, 100px);
            font-weight: 900;
            margin-bottom: 60px;
            letter-spacing: -0.02em;
            color: #FFFFFF;
            line-height: 0.95;
            position: relative;
            z-index: 1;
        }

        .rsvp-event-time {
            font-family: 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
            font-size: 18px;
            color: #FFFFFF;
            margin-bottom: 80px;
            line-height: 1.8;
            border-left: 2px solid #FFFFFF;
            padding-left: 20px;
            position: relative;
            z-index: 1;
            font-weight: 700;
        }

        .rsvp-form {
            margin-bottom: 40px;
        }

        .rsvp-input {
            width: 100%;
            padding: 16px 8px;
            background: transparent;
            border: none;
            border-bottom: 2px solid #FFFFFF;
            border-radius: 0 !important;
            color: #FFFFFF;
            font-size: 18px;
            font-family: 'Courier New', 'Courier', monospace;
            margin-bottom: 40px;
            transition: none;
            position: relative;
            z-index: 1;
        }

        .rsvp-input:focus {
            outline: none;
            border-bottom-color: #FFFFFF;
        }

        .rsvp-input::placeholder {
            color: #666666;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.05em;
        }

        .rsvp-buttons {
            display: flex;
            gap: 0;
            justify-content: center;
        }

        .rsvp-submit {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 0 !important;
            font-size: 20px;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            cursor: pointer;
            transition: opacity 0.2s;
            font-family: 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
            font-weight: 900;
            position: relative;
            z-index: 1;
            background: #FFFFFF;
            color: #000000;
            margin-bottom: 40px;
        }

        .rsvp-submit:hover {
            opacity: 0.9;
        }

        .rsvp-submit:active {
            transform: scale(0.98);
        }

        /* Calendar buttons */
        .rsvp-calendar {
            width: 100%;
            padding: 16px;
            background: transparent;
            border: 1px solid #FFFFFF;
            border-radius: 0 !important;
            color: #FFFFFF;
            font-size: 12px;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Courier New', 'Courier', monospace;
            font-weight: bold;
            text-transform: uppercase;
            position: relative;
            z-index: 1;
            display: block;
        }

        .rsvp-calendar:hover {
            background: #FFFFFF;
            color: #000000;
        }

        .rsvp-calendar:active {
            transform: scale(0.98);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .rsvp-content {
                padding: 20px 16px;
            }

            .rsvp-event-title {
                font-size: clamp(48px, 10vw, 64px);
                margin-bottom: 40px;
            }

            .rsvp-event-time {
                font-size: 16px;
                margin-bottom: 60px;
            }

            .rsvp-input {
                font-size: 16px;
            }

            .rsvp-submit {
                font-size: 16px;
                padding: 18px;
            }

            .rsvp-calendar {
                font-size: 11px;
                padding: 14px;
            }
        }

        @media (max-width: 768px) {
            .header {
                top: 8vh;
            }

            .center-time {
                margin-bottom: 0.5rem;
            }

            .center-duration {
                margin-bottom: 1.5rem;
            }

            .rsvp-buttons {
                flex-direction: column;
            }

            .rsvp-submit, .rsvp-close {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .header {
                top: 6vh;
            }
        }

        @media (max-height: 700px) {
            .header {
                top: 5vh;
            }
        }

        @media (max-height: 600px) {
            .header {
                top: 3vh;
            }
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>

    <!-- Dark overlay for better text readability inside ring -->
    <div class="ring-overlay"></div>


    <div class="ui-overlay">
        <div class="header">
            <h1 class="title" id="mainTitle">Holiday Season with Caspar</h1>
        </div>

        <div class="center-info" id="centerInfo">
            <div class="center-event" id="centerEvent">Bowling</div>
            <div class="center-date" id="centerDate">November 12</div>
            <div class="center-time" id="centerTime">20:00</div>
            <div class="center-location" id="centerLocation">Berolina</div>
            <button class="rsvp-button" id="rsvpButton">RSVP</button>
        </div>
    </div>

    <!-- RSVP Modal -->
    <div class="rsvp-modal" id="rsvpModal">
        <div class="rsvp-content">
            <button class="rsvp-close-btn" id="rsvpCloseBtn" aria-label="Close">√ó</button>
            <h2 class="rsvp-event-title" id="modalEventTitle">Bowling</h2>
            <div class="rsvp-event-time" id="modalEventTime">November 12<br>20:00<br>Address here</div>

            <form class="rsvp-form" id="rsvpForm">
                <input type="text" class="rsvp-input" placeholder="YOUR NAME" required id="rsvpName" autocomplete="name">
                <input type="text" class="rsvp-input" placeholder="PLUS ONES (OPTIONAL)" id="rsvpPlusOnes" autocomplete="off">
            </form>

            <div class="rsvp-buttons">
                <button class="rsvp-submit" id="rsvpSubmit">I'M COMING</button>
            </div>

            <div style="border-top: 1px solid #FFFFFF; padding-top: 40px; margin-bottom: 0;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="rsvp-calendar" id="addToGoogleCal">+ GOOGLE</button>
                    <button class="rsvp-calendar" id="addToAppleCal">+ APPLE</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        // Check if post-processing loaded
        window.addEventListener('load', () => {
            console.log('EffectComposer:', typeof THREE.EffectComposer);
            console.log('UnrealBloomPass:', typeof THREE.UnrealBloomPass);
        });
    </script>

    <script>
        const events = [
            { date: 'December 23', time: '19:00', endTime: '20:00', title: 'Luther & Wegner Dinner', location: 'KaDeWe, 6. Etage', address: 'KaDeWe, Tauentzienstra√üe 21-24, 10789 Berlin', color: 0xD4AF37 },  // Rich gold
            { date: 'December 23', time: '20:00', endTime: '22:00', title: 'Champagner BAR', location: 'KaDeWe, 6. Etage', address: 'KaDeWe, Tauentzienstra√üe 21-24, 10789 Berlin', color: 0xF4E4C1 },  // Pearl champagne
            { date: 'December 24', time: '18:00', endTime: '23:00', title: 'Weihnachten & Spiele', location: 'Studio 15. Stock', address: 'Lietzenburger Stra√üe 86, 10719 Berlin', color: 0xC41E3A, youtubeUrl: 'https://www.youtube.com/watch?v=rgEP1niScLc&t=74&autoplay=1' },  // Ruby red
            { date: 'December 24', time: '23:00', endTime: '02:00', title: 'Kupferkanne', location: 'Kupferkanne', address: 'Kurf√ºrstendamm 216, 10719 Berlin', color: 0x2C5F2D },  // Forest emerald
            { date: 'December 27', time: '12:00', endTime: '20:00', title: 'SPA', location: 'Location TBD', address: 'TBD', color: 0xC0C0C0 },  // Chrome silver
            { date: 'December 31', time: '19:00', endTime: '23:00', title: 'Silvester: Buffet und Rituale', location: 'Studio 15. Stock', address: 'Lietzenburger Stra√üe 86, 10719 Berlin', color: 0xE8E5D2 },  // Platinum
            { date: 'December 31', time: '23:00', endTime: '05:00', title: 'NYE Party', location: 'Studio 15. Stock', address: 'Lietzenburger Stra√üe 86, 10719 Berlin', color: 0xB87333 }  // Rose copper
        ];

        // Scene setup

        // Scene setup - PROPER responsive sizing that works on ANY device
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();

        // Calculate available space for ring - different for mobile vs desktop
        function calculateRingSize() {
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const isMobile = vw < 768;

            let headerSpace, bottomMargin, sideMargin, ringScale;

            if (isMobile) {
                // Mobile: move ring down, make room for title at top
                headerSpace = vh * 0.22; // More space at top for title
                bottomMargin = vh * 0.10; // Less space at bottom (ring moves down)
                sideMargin = vw * 0.08;
                ringScale = 0.90; // Fill 90% of available space
            } else {
                // Desktop: smaller ring, centered nicely
                headerSpace = vh * 0.25;
                bottomMargin = vh * 0.15;
                sideMargin = vw * 0.20; // More side margins on desktop
                ringScale = 0.65; // Smaller on desktop (65% of space)
            }

            // Available space for ring
            const availableHeight = vh - headerSpace - bottomMargin;
            const availableWidth = vw - (sideMargin * 2);

            // Ring should fit in the smaller dimension
            const maxDiameter = Math.min(availableHeight, availableWidth) * ringScale;

            // Convert to Three.js units
            const ringRadiusInUnits = 2.5;
            const cameraDistance = ringRadiusInUnits / Math.tan((50 * Math.PI / 180) / 2) * (600 / maxDiameter);

            return {
                radius: ringRadiusInUnits,
                cameraZ: cameraDistance,
                isMobile: isMobile
            };
        }

        const ringSize = calculateRingSize();
        const ringRadius = ringSize.radius;

        const camera = new THREE.PerspectiveCamera(
            50, // Fixed FOV for consistent perspective
            window.innerWidth / window.innerHeight,
            0.1,
            1000
        );
        camera.position.z = ringSize.cameraZ;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        container.appendChild(renderer.domElement);

        // Main ring - sophisticated silver for Christmas
        const ringGeometry = new THREE.TorusGeometry(ringRadius, 0.04, 32, 100);
        const ringMaterial = new THREE.MeshStandardMaterial({
            color: 0xC0C0C0,
            metalness: 0.8,
            roughness: 0.3,
            emissive: 0xC0C0C0,
            emissiveIntensity: 0.15
        });
        const ring = new THREE.Mesh(ringGeometry, ringMaterial);
        scene.add(ring);

        // Time segments - touchable slices
        const segments = [];
        const segmentAngle = (Math.PI * 2) / events.length;

        events.forEach((event, i) => {
            // Position segments clockwise starting from top (12 o'clock position)
            const startAngle = Math.PI / 2 - i * segmentAngle;
            const endAngle = Math.PI / 2 - (i + 1) * segmentAngle;

            const segmentGeometry = new THREE.TorusGeometry(
                ringRadius - 0.3, 0.12, 16, 32, segmentAngle
            );
            const segmentMaterial = new THREE.MeshStandardMaterial({
                color: 0x0B4D0B,  // Dark metallic green
                emissive: 0x000000,  // No glow - prevents white outline
                emissiveIntensity: 0,
                transparent: true,
                opacity: 0.3,
                metalness: 0.8,  // High metalness for metallic appearance
                roughness: 0.3   // Low roughness for shiny appearance
            });

            const segment = new THREE.Mesh(segmentGeometry, segmentMaterial);
            segment.rotation.z = startAngle;
            segment.userData = { index: i, event, isSegment: true };

            segments.push(segment);
            scene.add(segment);
        });

        // Event markers - larger hit area for better touch detection
        const markers = [];
        events.forEach((event, i) => {
            // Position events clockwise starting from top (12 o'clock position)
            const angle = Math.PI / 2 - (i / events.length) * Math.PI * 2;

            // Visible sphere - ULTRA-realistic Christmas ornament (Christbaum Kugel)
            const markerGeometry = new THREE.SphereGeometry(0.12, 64, 64);
            const beadColor = event.color;
            const markerMaterial = new THREE.MeshStandardMaterial({
                color: beadColor,
                emissive: beadColor,
                emissiveIntensity: 0.1,
                metalness: 1.0,            // Full metallic
                roughness: 0.15            // Polished metal finish
            });

            const marker = new THREE.Mesh(markerGeometry, markerMaterial);
            marker.position.x = Math.cos(angle) * ringRadius;
            marker.position.y = Math.sin(angle) * ringRadius;
            marker.userData = { index: i, event };

            // Add invisible larger hit area for easier touching
            const hitAreaGeometry = new THREE.SphereGeometry(0.3, 16, 16);
            const hitAreaMaterial = new THREE.MeshBasicMaterial({
                visible: false
            });
            const hitArea = new THREE.Mesh(hitAreaGeometry, hitAreaMaterial);
            hitArea.userData = { index: i, event };
            marker.add(hitArea);

            markers.push(marker);
            scene.add(marker);
        });

        // Lighting - enhanced for subtle 3D depth
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.35);
        scene.add(ambientLight);

        const pointLight = new THREE.PointLight(0xffffff, 0.9, 100);
        pointLight.position.set(5, 5, 5);
        scene.add(pointLight);

        const fillLight = new THREE.PointLight(0xffffff, 0.3, 100);
        fillLight.position.set(-5, -5, 3);
        scene.add(fillLight);

        // Rim light from behind for 3D depth
        const rimLight = new THREE.PointLight(0xffffff, 0.5, 100);
        rimLight.position.set(0, 0, -5);
        scene.add(rimLight);

        // ========== CHRISTMAS EFFECTS SYSTEMS ==========

        // Event 0: Luther & Wegner - Dinner Plate with Santa Hat
        const dinnerPlate = document.createElement('img');
        dinnerPlate.src = '/dinner-santa-plate.png';
        const isMobileForPlate = window.innerWidth < 768;
        const plateSize = isMobileForPlate ? '90vw' : '80vw';
        dinnerPlate.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: ${plateSize};
            max-width: 1200px;
            height: auto;
            object-fit: contain;
            opacity: 0;
            pointer-events: none;
            z-index: 0;
            transition: opacity 0.5s ease;
        `;
        document.body.appendChild(dinnerPlate);

        let dinnerPlateActive = false;

        function activateDinnerPlate() {
            dinnerPlateActive = true;
            dinnerPlate.style.opacity = '1';
            document.querySelector('.ring-overlay').classList.add('dinner-plate-active');
            console.log('üç¥ Dinner plate activated');
        }

        function deactivateDinnerPlate() {
            dinnerPlateActive = false;
            dinnerPlate.style.opacity = '0';
            document.querySelector('.ring-overlay').classList.remove('dinner-plate-active');
            console.log('üç¥ Dinner plate deactivated');
        }

        // Event 1: Champagner BAR - YouTube Video
        const champagneVideo = document.createElement('iframe');
        champagneVideo.src = 'https://www.youtube.com/embed/STH3VwMJP7Q?autoplay=1&mute=1&loop=1&playlist=STH3VwMJP7Q&controls=0&showinfo=0&rel=0&modestbranding=1';
        champagneVideo.allow = 'autoplay; encrypted-media';
        champagneVideo.className = 'youtube-video-bg';
        champagneVideo.style.width = '177.77vh';
        champagneVideo.style.height = '100vw';
        champagneVideo.setAttribute('frameborder', '0');
        document.body.appendChild(champagneVideo);

        let champagneVideoActive = false;

        function activateChampagneVideo() {
            champagneVideoActive = true;
            champagneVideo.classList.add('active');
            console.log('üçæ Champagne video activated');
        }

        function deactivateChampagneVideo() {
            champagneVideoActive = false;
            champagneVideo.classList.remove('active');
            console.log('üçæ Champagne video deactivated');
        }

        // Event 2: Weihnachten - Christmas Emoji Particles
        let christmasEmojiInterval = null;
        let christmasEmojiActive = false;
        const christmasEmojis = ['üéÑ', 'üéÖ', 'ü§∂', 'üéÅ', '‚õÑ', '‚ùÑÔ∏è', 'üåü'];

        function createChristmasEmoji() {
            const emoji = document.createElement('div');
            emoji.className = 'christmas-emoji';
            emoji.textContent = christmasEmojis[Math.floor(Math.random() * christmasEmojis.length)];

            const startX = Math.random() * window.innerWidth;
            const startY = Math.random() * window.innerHeight;
            emoji.style.left = startX + 'px';
            emoji.style.top = startY + 'px';

            const tx = (Math.random() - 0.5) * 400;
            const ty = (Math.random() - 0.5) * 400;
            const rotate = (Math.random() - 0.5) * 720;

            emoji.style.setProperty('--tx', tx + 'px');
            emoji.style.setProperty('--ty', ty + 'px');
            emoji.style.setProperty('--rotate', rotate + 'deg');

            document.body.appendChild(emoji);

            setTimeout(() => {
                emoji.remove();
            }, 3000);
        }

        function activateChristmasEmojis() {
            if (christmasEmojiActive) return;
            christmasEmojiActive = true;

            for (let i = 0; i < 8; i++) {
                setTimeout(() => createChristmasEmoji(), i * 100);
            }

            christmasEmojiInterval = setInterval(() => {
                createChristmasEmoji();
            }, 400);

            console.log('üéÑ Christmas emojis activated');
        }

        function deactivateChristmasEmojis() {
            if (!christmasEmojiActive) return;
            christmasEmojiActive = false;

            if (christmasEmojiInterval) {
                clearInterval(christmasEmojiInterval);
                christmasEmojiInterval = null;
            }

            document.querySelectorAll('.christmas-emoji').forEach(emoji => {
                emoji.remove();
            });

            console.log('üéÑ Christmas emojis deactivated');
        }

        // Event 3: Kupferkanne - Beer Emojis + Background
        let beerEmojiInterval = null;
        let beerEmojiActive = false;
        const beerEmojis = ['üç∫', 'üçª'];

        function createBeerEmoji() {
            const emoji = document.createElement('div');
            emoji.className = 'beer-emoji';
            emoji.textContent = beerEmojis[Math.floor(Math.random() * beerEmojis.length)];

            const startX = Math.random() * window.innerWidth;
            const startY = Math.random() * window.innerHeight;
            emoji.style.left = startX + 'px';
            emoji.style.top = startY + 'px';

            const tx = (Math.random() - 0.5) * 400;
            const ty = (Math.random() - 0.5) * 400;
            const rotate = (Math.random() - 0.5) * 720;

            emoji.style.setProperty('--tx', tx + 'px');
            emoji.style.setProperty('--ty', ty + 'px');
            emoji.style.setProperty('--rotate', rotate + 'deg');

            document.body.appendChild(emoji);

            setTimeout(() => {
                emoji.remove();
            }, 3000);
        }

        function activateKupferkanne() {
            if (beerEmojiActive) return;
            beerEmojiActive = true;

            document.body.classList.add('kupferkanne-active');

            for (let i = 0; i < 8; i++) {
                setTimeout(() => createBeerEmoji(), i * 100);
            }

            beerEmojiInterval = setInterval(() => {
                createBeerEmoji();
            }, 400);

            console.log('üç∫ Kupferkanne (beer + background) activated');
        }

        function deactivateKupferkanne() {
            if (!beerEmojiActive) return;
            beerEmojiActive = false;

            document.body.classList.remove('kupferkanne-active');

            if (beerEmojiInterval) {
                clearInterval(beerEmojiInterval);
                beerEmojiInterval = null;
            }

            document.querySelectorAll('.beer-emoji').forEach(emoji => {
                emoji.remove();
            });

            console.log('üç∫ Kupferkanne deactivated');
        }

        // Event 4: SPA - Sauna Background
        function activateSauna() {
            document.body.classList.add('sauna-active');
            console.log('üßñ Sauna background activated');
        }

        function deactivateSauna() {
            document.body.classList.remove('sauna-active');
            console.log('üßñ Sauna background deactivated');
        }

        // Event 5: Silvester Buffet - Dinner for One Background
        function activateDinnerForOne() {
            document.body.classList.add('dinner-for-one-active');
            console.log('üçΩÔ∏è Dinner for One background activated');
        }

        function deactivateDinnerForOne() {
            document.body.classList.remove('dinner-for-one-active');
            console.log('üçΩÔ∏è Dinner for One background deactivated');
        }

        // Event 6: NYE Party - Fireworks YouTube Video
        const fireworksVideo = document.createElement('iframe');
        fireworksVideo.src = 'https://www.youtube.com/embed/RfGu1THRr3U?autoplay=1&mute=1&loop=1&playlist=RfGu1THRr3U&controls=0&showinfo=0&rel=0&modestbranding=1';
        fireworksVideo.allow = 'autoplay; encrypted-media';
        fireworksVideo.className = 'youtube-video-bg';
        fireworksVideo.style.width = '177.77vh';
        fireworksVideo.style.height = '100vw';
        fireworksVideo.setAttribute('frameborder', '0');
        document.body.appendChild(fireworksVideo);

        let fireworksVideoActive = false;

        function activateFireworksVideo() {
            fireworksVideoActive = true;
            fireworksVideo.classList.add('active');
            console.log('üéÜ Fireworks video activated');
        }

        function deactivateFireworksVideo() {
            fireworksVideoActive = false;
            fireworksVideo.classList.remove('active');
            console.log('üéÜ Fireworks video deactivated');
        }

        // ========== END CHRISTMAS EFFECTS SYSTEMS ==========

        // Interaction
        let isDragging = false;
        let previousMouseX = 0;
        let rotationVelocity = 0;
        let currentActive = null;
        let blinkAnimation = null; // Track the blinking animation

        const raycaster = new THREE.Raycaster();
        raycaster.params.Mesh.threshold = 0.2; // Increase hit detection threshold
        const mouse = new THREE.Vector2();

        function onPointerDown(e) {
            isDragging = true;
            container.classList.add('dragging');
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            previousMouseX = clientX;
            rotationVelocity = 0;
        }

        function onPointerMove(e) {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            mouse.x = (clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(clientY / window.innerHeight) * 2 + 1;

            if (isDragging) {
                const deltaX = clientX - previousMouseX;
                rotationVelocity = deltaX * 0.01;
                previousMouseX = clientX;
            }
        }

        function onPointerUp() {
            isDragging = false;
            container.classList.remove('dragging');
        }

        function checkIntersections() {
            raycaster.setFromCamera(mouse, camera);

            // Check segments AND markers (entire slice is touchable)
            const allObjects = [];

            // Add all segments
            segments.forEach(s => allObjects.push(s));

            // Add markers and their children (hit areas)
            markers.forEach(m => {
                allObjects.push(m);
                m.children.forEach(child => allObjects.push(child));
            });

            const intersects = raycaster.intersectObjects(allObjects);

            if (intersects.length > 0) {
                const index = intersects[0].object.userData.index;
                if (index !== undefined) {
                    activateEvent(index);
                }
            } else if (!isDragging) {
                deactivateEvent();
            }
        }

        function activateEvent(index) {
            if (currentActive === index) return;

            // Deactivate previous
            if (currentActive !== null) {
                // Kill the blinking animation
                if (blinkAnimation) {
                    blinkAnimation.kill();
                    blinkAnimation = null;
                }

                gsap.to(segments[currentActive].material, {
                    emissiveIntensity: 0,
                    duration: 0.5
                });
                gsap.to(markers[currentActive].scale, {
                    x: 1, y: 1, z: 1,
                    duration: 0.4,
                    ease: 'power2.out'
                });
                gsap.to(markers[currentActive].material, {
                    emissiveIntensity: 0.15,
                    duration: 0.4
                });

                // Deactivate Christmas effects when switching events
                if (currentActive === 0) {
                    deactivateDinnerPlate();
                }

                if (currentActive === 1) {
                    deactivateChampagneVideo();
                }

                if (currentActive === 2) {
                    deactivateChristmasEmojis();
                }

                if (currentActive === 3) {
                    deactivateKupferkanne();
                }

                if (currentActive === 4) {
                    deactivateSauna();
                }

                if (currentActive === 5) {
                    deactivateDinnerForOne();
                }

                if (currentActive === 6) {
                    deactivateFireworksVideo();
                }
            }

            currentActive = index;
            const event = events[index];

            // Activate segment
            gsap.to(segments[index].material, {
                emissiveIntensity: 0.6,
                duration: 0.6,
                ease: 'power2.out'
            });

            // Scale marker
            gsap.to(markers[index].scale, {
                x: 1.5, y: 1.5, z: 1.5,
                duration: 0.5,
                ease: 'elastic.out(1, 0.5)'
            });

            // Christmas light blinking effect (brighter)
            blinkAnimation = gsap.to(markers[index].material, {
                emissiveIntensity: 0.4,
                duration: 0.5,
                repeat: -1,
                yoyo: true,
                ease: 'power1.inOut'
            });

            // Update center info with GSAP
            const centerInfo = document.getElementById('centerInfo');
            const centerTime = document.getElementById('centerTime');
            const centerEvent = document.getElementById('centerEvent');
            const centerDate = document.getElementById('centerDate');
            const centerLocation = document.getElementById('centerLocation');

            // Fade out current
            gsap.to(centerInfo, {
                opacity: 0,
                duration: 0.2,
                onComplete: () => {
                    // Update content - line break between title and date
                    centerEvent.textContent = event.title;
                    centerDate.textContent = event.date;
                    centerTime.textContent = event.time;
                    centerLocation.textContent = event.location;

                    // Fade in new
                    centerInfo.classList.add('show');
                    gsap.to(centerInfo, {
                        opacity: 1,
                        duration: 0.5,
                        ease: 'power2.out'
                    });

                    gsap.fromTo(centerTime,
                        { scale: 0.9, opacity: 0 },
                        { scale: 1, opacity: 1, duration: 0.6, ease: 'back.out(1.7)' }
                    );
                }
            });

            // Update RSVP button - show modal
            document.getElementById('rsvpButton').onclick = (e) => {
                e.stopPropagation();
                openRSVPModal(event);
            };

            // Activate Christmas effects
            if (index === 0) {
                activateDinnerPlate();
            }

            if (index === 1) {
                activateChampagneVideo();
            }

            if (index === 2) {
                activateChristmasEmojis();
            }

            if (index === 3) {
                activateKupferkanne();
            }

            if (index === 4) {
                activateSauna();
            }

            if (index === 5) {
                activateDinnerForOne();
            }

            if (index === 6) {
                activateFireworksVideo();
            }

            // Haptic
            if (navigator.vibrate) navigator.vibrate(10);
        }

        function deactivateEvent() {
            if (currentActive === null) return;

            gsap.to(segments[currentActive].material, {
                emissiveIntensity: 0,
                duration: 0.5
            });

            gsap.to(markers[currentActive].scale, {
                x: 1, y: 1, z: 1,
                duration: 0.4,
                ease: 'power2.out'
            });

            gsap.to(markers[currentActive].material, {
                emissiveIntensity: 0.2,
                duration: 0.4
            });

            gsap.to('#centerInfo', {
                opacity: 0,
                duration: 0.3,
                onComplete: () => {
                    document.getElementById('centerInfo').classList.remove('show');
                }
            });

            // Deactivate Christmas effects
            if (currentActive === 0) {
                deactivateDinnerPlate();
            }

            if (currentActive === 1) {
                deactivateChampagneVideo();
            }

            if (currentActive === 2) {
                deactivateChristmasEmojis();
            }

            if (currentActive === 3) {
                deactivateKupferkanne();
            }

            if (currentActive === 4) {
                deactivateSauna();
            }

            if (currentActive === 5) {
                deactivateDinnerForOne();
            }

            if (currentActive === 6) {
                deactivateFireworksVideo();
            }

            currentActive = null;
        }

        // Event listeners
        container.addEventListener('mousedown', onPointerDown);
        container.addEventListener('mousemove', onPointerMove);
        container.addEventListener('mouseup', onPointerUp);
        container.addEventListener('touchstart', onPointerDown, { passive: true });
        container.addEventListener('touchmove', onPointerMove, { passive: true });
        container.addEventListener('touchend', onPointerUp);

        // Animation loop
        let lastTime = Date.now();

        function animate() {
            requestAnimationFrame(animate);

            const currentTime = Date.now();
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;

            if (!isDragging) {
                rotationVelocity *= 0.95;
            }

            ring.rotation.z += rotationVelocity;

            segments.forEach(segment => {
                segment.rotation.z += rotationVelocity;
            });

            markers.forEach(marker => {
                const currentAngle = Math.atan2(marker.position.y, marker.position.x);
                const newAngle = currentAngle + rotationVelocity;
                marker.position.x = Math.cos(newAngle) * ringRadius;
                marker.position.y = Math.sin(newAngle) * ringRadius;
            });

            if (!isDragging) {
                checkIntersections();
            }

            // Subtle pulse
            ring.scale.setScalar(1 + Math.sin(Date.now() * 0.0008) * 0.008);

            // Render scene
            renderer.render(scene, camera);
        }

        // RSVP Modal functions
        let currentEventForRSVP = null;

        function openRSVPModal(event) {
            currentEventForRSVP = event;

            // Set title
            const titleElement = document.getElementById('modalEventTitle');
            titleElement.textContent = event.title;

            let timeHTML = `${event.date}<br>${event.time}<br>${event.address}`;

            // DEBUG: Log event object and youtubeUrl property
            console.log('DEBUG openRSVPModal - Event:', event);
            console.log('DEBUG openRSVPModal - event.youtubeUrl:', event.youtubeUrl);
            console.log('DEBUG openRSVPModal - Has youtubeUrl?', !!event.youtubeUrl);

            // VISIBLE DEBUG on page
            if (event.youtubeUrl) {
                timeHTML += `<br><br><div style="color: lime; font-weight: bold;">DEBUG: youtubeUrl found = ${event.youtubeUrl}</div>`;
            } else {
                timeHTML += `<br><br><div style="color: red; font-weight: bold;">DEBUG: NO youtubeUrl property</div>`;
            }

            // Add embedded YouTube video if present
            if (event.youtubeUrl) {
                console.log('DEBUG - Adding YouTube iframe to timeHTML');
                timeHTML += `<br><br><iframe width="100%" height="200" src="https://www.youtube.com/embed/rgEP1niScLc?start=74&autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="border-radius: 8px; margin-top: 10px;"></iframe>`;
            } else {
                console.log('DEBUG - No youtubeUrl found, skipping iframe');
            }

            console.log('DEBUG - Final timeHTML:', timeHTML);

            document.getElementById('modalEventTime').innerHTML = timeHTML;

            const modal = document.getElementById('rsvpModal');
            const content = document.querySelector('.rsvp-content');
            const time = document.getElementById('modalEventTime');
            const inputs = document.querySelectorAll('.rsvp-input');
            const buttons = document.querySelectorAll('.rsvp-submit, #addToGoogleCal, #addToAppleCal');

            // RESET BUTTON STATE - FIX for stuck "LOCKED IN" text
            const submitBtn = document.getElementById('rsvpSubmit');
            submitBtn.textContent = "I'M COMING";
            submitBtn.style.background = '';
            submitBtn.style.color = '';

            // Reset states
            gsap.set(content, { scale: 0.8, opacity: 0 });
            gsap.set(titleElement, { y: 20, opacity: 0 });
            gsap.set(time, { y: 20, opacity: 0 });
            gsap.set(inputs, { y: 20, opacity: 0 });
            gsap.set(buttons, { y: 20, opacity: 0 });

            // Show modal
            modal.classList.add('show');

            // Simple but elegant entrance sequence
            const timeline = gsap.timeline();

            // Modal background fades in
            timeline.to(modal, {
                opacity: 1,
                duration: 0.3,
                ease: 'power2.out'
            })
            // Card pops in
            .to(content, {
                scale: 1,
                opacity: 1,
                duration: 0.5,
                ease: 'back.out(1.5)',
            }, '-=0.1')
            // Title slides up
            .to(titleElement, {
                y: 0,
                opacity: 1,
                duration: 0.4,
                ease: 'power3.out'
            }, '-=0.2')
            // Time slides up
            .to(time, {
                y: 0,
                opacity: 1,
                duration: 0.4,
                ease: 'power3.out'
            }, '-=0.2')
            // Inputs fade in
            .to(inputs, {
                y: 0,
                opacity: 1,
                duration: 0.4,
                stagger: 0.1,
                ease: 'power2.out'
            }, '-=0.2')
            // Buttons fade in
            .to(buttons, {
                y: 0,
                opacity: 1,
                duration: 0.4,
                stagger: 0.08,
                ease: 'power2.out'
            }, '-=0.2');
        }

        function closeRSVPModal() {
            const modal = document.getElementById('rsvpModal');
            const content = document.querySelector('.rsvp-content');

            // Simple fade out
            gsap.to(content, {
                scale: 0.9,
                opacity: 0,
                duration: 0.25,
                ease: 'power2.in'
            });

            gsap.to(modal, {
                opacity: 0,
                duration: 0.25,
                ease: 'power2.in',
                onComplete: () => {
                    modal.classList.remove('show');
                    document.getElementById('rsvpName').value = '';
                    document.getElementById('rsvpPlusOnes').value = '';
                }
            });
        }


        // Generate ICS calendar file
        function generateCalendarFile(event) {
            // Parse date and time
            const dateStr = event.date; // "November 12" or "November 13"
            const timeStr = event.time; // "20:00"
            const endTimeStr = event.endTime; // "22:00"

            // Build full date string for 2025
            const month = dateStr.split(' ')[0];
            const day = parseInt(dateStr.split(' ')[1]);
            const year = 2025;

            // Parse times
            const [startHour, startMin] = timeStr.split(':').map(n => parseInt(n));
            const [endHour, endMin] = endTimeStr.split(':').map(n => parseInt(n));

            // Month mapping
            const monthMap = {
                'January': 0, 'February': 1, 'March': 2, 'April': 3,
                'May': 4, 'June': 5, 'July': 6, 'August': 7,
                'September': 8, 'October': 9, 'November': 10, 'December': 11
            };

            // Create Date objects in Berlin timezone (CET/CEST)
            // November is CET (UTC+1), no DST
            const startDate = new Date(Date.UTC(year, monthMap[month], day, startHour - 1, startMin, 0));
            const endDate = new Date(Date.UTC(year, monthMap[month], day, endHour - 1, endMin, 0));

            // Format dates for ICS (YYYYMMDDTHHMMSSZ format in UTC)
            function formatICSDate(date) {
                const year = date.getUTCFullYear();
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const day = String(date.getUTCDate()).padStart(2, '0');
                const hours = String(date.getUTCHours()).padStart(2, '0');
                const minutes = String(date.getUTCMinutes()).padStart(2, '0');
                const seconds = String(date.getUTCSeconds()).padStart(2, '0');
                return `${year}${month}${day}T${hours}${minutes}${seconds}Z`;
            }

            const startICS = formatICSDate(startDate);
            const endICS = formatICSDate(endDate);
            const now = formatICSDate(new Date());

            // Generate ICS content with proper formatting for Google Calendar
            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//40 Hours with Caspar//casparboehme.com//EN',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'X-WR-CALNAME:40 Hours with Caspar',
                'X-WR-TIMEZONE:Europe/Berlin',
                'BEGIN:VEVENT',
                `UID:${now}-${event.title.replace(/\s/g, '-').replace(/√§/g, 'a').replace(/√∂/g, 'o').replace(/√º/g, 'u')}@casparboehme.com`,
                `DTSTAMP:${now}`,
                `DTSTART:${startICS}`,
                `DTEND:${endICS}`,
                `SUMMARY:${event.title} - 40 Hours with Caspar`,
                `LOCATION:${event.address}`,
                `DESCRIPTION:Join us for ${event.title}!\\n\\nLocation: ${event.address}\\n\\nPart of Caspar's 40-hour birthday celebration November 12-13\\, 2025.`,
                'STATUS:CONFIRMED',
                'TRANSP:OPAQUE',
                'SEQUENCE:0',
                'BEGIN:VALARM',
                'TRIGGER:-PT30M',
                `DESCRIPTION:${event.title} in 30 minutes`,
                'ACTION:DISPLAY',
                'END:VALARM',
                'END:VEVENT',
                'END:VCALENDAR'
            ].join('\r\n');

            return icsContent;
        }

        function downloadCalendarFile() {
            if (!currentEventForRSVP) return;

            const icsContent = generateCalendarFile(currentEventForRSVP);
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `40-hours-caspar-${currentEventForRSVP.title.replace(/\s/g, '-').toLowerCase()}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            console.log('üìÖ Calendar file downloaded:', currentEventForRSVP.title);
        }

        function addToGoogleCalendar() {
            if (!currentEventForRSVP) return;

            const event = currentEventForRSVP;

            // Parse date and time for Google Calendar URL
            const dateStr = event.date;
            const month = dateStr.split(' ')[0];
            const day = parseInt(dateStr.split(' ')[1]);
            const year = 2025;

            const [startHour, startMin] = event.time.split(':').map(n => parseInt(n));
            const [endHour, endMin] = event.endTime.split(':').map(n => parseInt(n));

            const monthMap = {
                'January': 0, 'February': 1, 'March': 2, 'April': 3,
                'May': 4, 'June': 5, 'July': 6, 'August': 7,
                'September': 8, 'October': 9, 'November': 10, 'December': 11
            };

            // Create dates in Berlin timezone (UTC+1 for November)
            const startDate = new Date(Date.UTC(year, monthMap[month], day, startHour - 1, startMin, 0));
            const endDate = new Date(Date.UTC(year, monthMap[month], day, endHour - 1, endMin, 0));

            // Format for Google Calendar (YYYYMMDDTHHMMSSZ)
            function formatGoogleDate(date) {
                const year = date.getUTCFullYear();
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const day = String(date.getUTCDate()).padStart(2, '0');
                const hours = String(date.getUTCHours()).padStart(2, '0');
                const minutes = String(date.getUTCMinutes()).padStart(2, '0');
                const seconds = String(date.getUTCSeconds()).padStart(2, '0');
                return `${year}${month}${day}T${hours}${minutes}${seconds}Z`;
            }

            const startFormatted = formatGoogleDate(startDate);
            const endFormatted = formatGoogleDate(endDate);

            // Build Google Calendar URL
            const title = encodeURIComponent(`${event.title} - 40 Hours with Caspar`);
            const dates = `${startFormatted}/${endFormatted}`;
            const details = encodeURIComponent(`Join us for ${event.title}!\n\nLocation: ${event.address}\n\nPart of Caspar's 40-hour birthday celebration November 12-13, 2025.`);
            const location = encodeURIComponent(event.address);

            const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dates}&details=${details}&location=${location}`;

            // Open in new tab
            window.open(googleCalendarUrl, '_blank');

            console.log('üìÖ Opening Google Calendar for:', event.title);
        }

        function addToAppleCalendar() {
            if (!currentEventForRSVP) return;

            const icsContent = generateCalendarFile(currentEventForRSVP);
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            // Open .ics file directly (will auto-open in Calendar app on Mac/iOS)
            window.location.href = url;

            // Clean up after a delay
            setTimeout(() => {
                URL.revokeObjectURL(url);
            }, 100);

            console.log('üìÖ Opening Apple Calendar for:', currentEventForRSVP.title);
        }

        async function submitRSVP() {
            const name = document.getElementById('rsvpName').value.trim();
            const plusOnes = document.getElementById('rsvpPlusOnes').value.trim();

            if (!name) {
                alert('Please enter your name');
                return;
            }

            // SAFETY CHECK: Prevent duplicate submissions
            const submitBtn = document.getElementById('rsvpSubmit');
            if (submitBtn.disabled) {
                console.log('‚ö†Ô∏è Duplicate submission prevented');
                return;
            }

            // Create event ID from title (e.g., "bowling", "brunch")
            const eventId = currentEventForRSVP.title.toLowerCase().replace(/\s+/g, '-');

            // Disable button during submission
            submitBtn.disabled = true;
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'SAVING...';

            try {
                console.log('üì§ Submitting RSVP:', { eventId, name, plusOnes: parseInt(plusOnes) || 0 });

                // Send RSVP to backend
                const response = await fetch('/api/rsvps', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        eventId: eventId,
                        name: name,
                        plusOnes: parseInt(plusOnes) || 0
                    })
                });

                const data = await response.json();
                console.log('üì• Response:', data);

                if (data.success) {
                    console.log('‚úÖ RSVP Saved Successfully:', {
                        event: currentEventForRSVP.title,
                        name: name,
                        plusOnes: plusOnes,
                        timestamp: new Date().toISOString()
                    });

                    // Download calendar file automatically on RSVP
                    downloadCalendarFile();

                    // Animate success message
                    submitBtn.textContent = '‚úì LOCKED IN';
                    submitBtn.style.background = '#FFFFFF';
                    submitBtn.style.color = '#000000';

                    // Keep modal open for 4 seconds so user can click calendar buttons
                    setTimeout(() => {
                        closeRSVPModal();
                        // Reset button state completely
                        setTimeout(() => {
                            submitBtn.textContent = "I'M COMING";
                            submitBtn.style.background = '';
                            submitBtn.style.color = '';
                            submitBtn.disabled = false;
                        }, 500);
                    }, 4000);
                } else {
                    throw new Error(data.error || 'Failed to save RSVP');
                }
            } catch (error) {
                console.error('‚ùå RSVP Error:', error);
                alert('Sorry, there was an error saving your RSVP. Please try again or contact support.');

                // Re-enable button on error
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // RSVP Modal event listeners
        document.getElementById('rsvpSubmit').addEventListener('click', submitRSVP);
        document.getElementById('addToGoogleCal').addEventListener('click', addToGoogleCalendar);
        document.getElementById('addToAppleCal').addEventListener('click', addToAppleCalendar);
        document.getElementById('rsvpCloseBtn').addEventListener('click', closeRSVPModal);

        document.getElementById('rsvpForm').addEventListener('submit', (e) => {
            e.preventDefault();
            submitRSVP();
        });

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('rsvpModal').classList.contains('show')) {
                closeRSVPModal();
            }
        });

        // Handle resize - recalculate for ANY screen size
        window.addEventListener('resize', () => {
            const newRingSize = calculateRingSize();
            camera.position.z = newRingSize.cameraZ;
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);

            // Update composer size if available
            if (composer) {
                composer.setSize(window.innerWidth, window.innerHeight);
            }

            // Update brunch plate size
            const isMobileNow = window.innerWidth < 768;
            const newPatternSize = isMobileNow ? '90vw' : '80vw';
            brunchPattern.style.width = newPatternSize;
        });

        animate();
        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
</body>
</html>
